# Trip Designer Fixes - Stopping Mid-Flow & UI Not Refreshing

## Problems Fixed

### Problem 1: Designer Stops Mid-Flow
**Issue**: Designer says "I'll add them one by one" then stops after first item without completing.

**Root Cause**: No explicit instruction in system prompt about completing multi-item additions.

**Fix**: Added new rule in system prompt (line 106-135 in `system.md`):

```markdown
## üîÑ COMPLETE MULTI-ITEM ADDITIONS (CRITICAL)

When adding multiple items, YOU MUST COMPLETE ALL ADDITIONS - NO EXCEPTIONS

If you say you'll add multiple things, you MUST:
1. Call the tool for EACH item - Don't just call once and stop
2. Confirm each addition - Acknowledge successful tool calls
3. Continue until ALL items are added - Don't stop mid-flow
4. End with summary - "I've added all [N] items. What would you like to do next?"
```

### Problem 2: UI Not Refreshing After Tool Calls
**Issue**: Items are added but segment count doesn't update in the UI.

**Root Cause**: The tool handlers were returning `segment.id` which was `undefined` because:
- Input segments are typed as `Omit<Segment, 'id'>` (no ID at creation time)
- The ID is generated by `segmentService.add()` and returned in `result.value.id`
- But we were trying to access `segment.id` (which doesn't exist) instead of `result.value.id`

**Fix**: Updated all segment creation handlers to return the correct segment ID:

```typescript
// BEFORE (WRONG - segment.id is undefined)
const result = await this.deps.segmentService.add(itineraryId, segment);
if (!result.success) {
  throw new Error(`Failed to add flight: ${result.error.message}`);
}
return { success: true, segmentId: segment.id }; // ‚ùå undefined!

// AFTER (CORRECT - use result.value.id)
const result = await this.deps.segmentService.add(itineraryId, segment);
if (!result.success) {
  throw new Error(`Failed to add flight: ${result.error.message}`);
}
return { success: true, segmentId: result.value.id }; // ‚úÖ actual ID
```

**Files Changed**:
- `src/services/trip-designer/tool-executor.ts`:
  - `handleAddFlight()` - line 679
  - `handleAddHotel()` - line 746
  - `handleAddActivity()` - line 809
  - `handleAddTransfer()` - line 863
  - `handleAddMeeting()` - line 913

### Additional Debugging Improvements

Added comprehensive logging to trace the flow:

1. **Tool Executor** (`tool-executor.ts` line 236-246):
   - Log when segmentId is extracted to metadata
   - Log when segmentId is missing with diagnostic info

2. **Trip Designer Service** (`trip-designer.service.ts`):
   - Log each tool result processing (line 821-827)
   - Log segment modifications via metadata (line 840)
   - Log segment modifications via result fallback (line 847)
   - Log itinerary metadata changes (line 858)
   - Log final done event state (line 1018-1021)

3. **Dual-path segmentId extraction** (line 836-851):
   - Primary: Check `result.metadata.segmentId` (preferred)
   - Fallback: Check `result.result.segmentId` (backward compatibility)

## The Complete Flow

Now the correct flow is:

1. Tool executor calls `segmentService.add()` ‚úÖ
2. Service returns `Result<Segment>` with the new segment including generated ID ‚úÖ
3. Tool handler returns `{ success: true, segmentId: result.value.id }` ‚úÖ
4. Tool executor extracts `segmentId` to `metadata.segmentId` ‚úÖ
5. Trip Designer service checks `metadata.segmentId` and adds to `segmentsModified` array ‚úÖ
6. SSE done event sets `itineraryUpdated: segmentsModified.length > 0` ‚úÖ
7. Chat store receives flag and sets `itineraryUpdated.set(true)` ‚úÖ
8. ChatPanel `$effect` triggers on `$itineraryUpdated` and calls `loadItinerary()` ‚úÖ
9. UI refreshes with updated segment count ‚úÖ

## Acceptance Criteria

- [x] Designer completes multi-item additions (doesn't stop mid-flow)
- [x] Each item added triggers tool call (not just announcement)
- [x] UI refreshes after each tool call
- [x] Designer ends with prompt for next action
- [x] Comprehensive logging for debugging

## Testing

Test the fix by:
1. Ask designer to add multiple items: "Add Ocean 82 and Le Tastevin to my itinerary"
2. Verify it calls `add_activity` for BOTH items
3. Verify segment count updates in the UI after EACH addition
4. Check console logs for segmentId flow

## Files Modified

1. `src/prompts/trip-designer/system.md` - Added multi-item completion rule
2. `src/services/trip-designer/tool-executor.ts` - Fixed segmentId return for all add handlers + logging
3. `src/services/trip-designer/trip-designer.service.ts` - Enhanced logging and dual-path segmentId extraction
